---
title:  "如何阅读 TiDB 的源代码（四）"
date: 2020-07-31T10:58:00+08:00
---

本篇会介绍 TiDB 中的某些重点函数和日志的解读。

## 重点函数

重点函数的定义因人而异，所以，本章节内容偏向主观。

### execute

![func](/posts/images/20200812152326.png)

execute 是文本协议执行的必经之路。它也很好的展示了 SQL 处理的各个过程。

1. ParseSQL 解析 SQL，最终的实现是在 parser 中，按照前面第二篇介绍的规则进行 SQL 的解析，这里要注意，解析出来的 SQL 可能是单条，也可能是多条。
TiDB 本身支持 multi-SQL 特性，允许一次性执行多条 SQL
1. 解析完成后，会返回 stmtNodes 数组，在下面的 for 循环中挨个处理。首先要做的是 Compile，Compile 本身的核心是要做优化，生成 plan，顺着 Optimize 一路找进去就能够找到

    ![func](/posts/images/20200812153017.png)

    可以看到这里分了逻辑优化、物理优化等与常见其他数据库类似。

1. 最后是执行部分，executeStatement 其中 runStmt 是另外一个重点函数。

### runStmt

![func](/posts/images/20200731111912.png)

从 runStmt 的 call graph 看，这个函数几乎是所有 SQL 执行的必经之路，除了走 binary 协议的自动提交的点查语句，其他所有语句都会经过这个函数。
这个函数承担的责任是 SQL 的执行，不包括，SQL 解析、编译过程（binary 协议不需要重复解析 SQL，使用 plan cache 后也不需要编译 SQL）。

![func](/posts/images/20200731112400.png)

runStmt 函数核心部分时候如上的部分。从上到下依旧是：

1. checkTxnAborted

    当事务已经损坏不能再提交的时候，需要用户主动关闭事务，来结束整个已经损坏的事务。事务在执行时会遇到一些无法处理的错误，此时事务只能终止，
    此时，不能偷偷地关闭事务，因为用户可能会继续执行 SQL，并假设 SQL 还在事务内。这个函数的作用就是，让用户的后续所有 SQL 不执行，直接报错，
    直到，用户使用 rollback、commit 这种显示关闭事务的 SQL 才正常执行。

1. Exec

    执行 SQL，并返回 rs (result set) 结果集。

1. IsReadOnly

    当一个 SQL 执行完，我们需要判断它是否是一个只读的 SQL，如果是非只读 SQL，要将 SQL 暂存到事务的执行历史中。执行历史是在事务发生冲突等错误
    需要重试的时候用来重试事务的。这里之所以绕开了只读的 SQL，是因为事务的重试是在事务提交的阶段完成的，此时返回给客户端的只能是提交成功和失败，
    读取结果已经没有意义。

    同时，这部分还进行了 StmtCommit 和 StmtRollback。TiDB 是支持 MySQL 一样的语句提交和回滚，也就是，当事务中的某个语句执行失败，单条语句会原子地回滚，其他执行成功的语句，最终会随着事务提交。

    在 TiDB 中，是以两层 buffer 来实现的语句提交特性，也就是，事务有自己的 buffer，语句也有自己的，当语句执行成功后，会把 buffer 刷入事务 buffer 进行融合。当语句执行失败后，语句 buffer 会被丢弃。这就保证了语句提交的原子性。当然，语句提交可能失败，如果失败的话，整个事务 buffer 将不可用，事务进入只能被回滚的阶段。

1. finishStmt

    当一个语句执行完成，是否该进行提交呢？这取决于是否是显示开启的事务，也就是 begin、start transaction 显示启动事务，再就是 autocommit 的是否开启？finishStmt 的作用就是在执行完语句后，检查是否该提交了，根据以上情况。相当于对每个语句结束进行一些清理和检查。

1. pending 部分

    TiDB 中有些 SQL 是不需要启动事务的，比如 set 语句，但是，语句被解析之前，数据库是不知道该语句是否需要启动事务。在 TiDB 中启动一个事务的 latency 也比较高，因为需要去 PD 获取一个 tso，因此，TiDB 有异步获取 tso 的优化，也就是，无论最终是否需要启动事务，都先准备好 tso，所以，当语句确实不需要 tso 时，也就是事务没有被激活，一直处于 pending 状态，此时，需要关闭这个 pending 中的事务。
    