---
title:  "如何阅读 TiDB 的源代码（四）"
date: 2020-07-31T10:58:00+08:00
---

本篇会介绍 TiDB 中的某些重点函数和日志的解读。

## 重点函数

重点函数的定义因人而异，所以，本章节内容偏向主观。

### runStmt

![func](/posts/images/20200731111912.png)

从 runStmt 的 call graph 看，这个函数几乎是所有 SQL 执行的必经之路，除了走 binary 协议的自动提交的点查语句，其他所有语句都会经过这个函数。
这个函数承担的责任是，SQL 的执行，不包括，SQL 解析、编译过程（binary 协议不需要重复解析 SQL，使用 plan cache 后也不需要编译 SQL）。

![func](/posts/images/20200731112400.png)

runStmt 函数核心部分时候如上的部分。从上到下依旧是：

1. checkTxnAborted

    当事务已经损坏不能再提交的时候，需要用户主动关闭事务，来结束整个已经损坏的事务。事务在执行时会遇到一些无法处理的错误，此时事务只能终止，
    此时，不能偷偷地关闭事务，因为用户可能会继续执行 SQL，并假设 SQL 还在事务内。这个函数的作用就是，让用户的后续所有 SQL 不执行，直接报错，
    直到，用户使用 rollback、commit 这种显示关闭事务的 SQL 才正常执行。
